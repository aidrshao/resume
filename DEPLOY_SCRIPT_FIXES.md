# deploy.sh 脚本修复说明

## 问题分析

根据您提供的错误信息，主要问题是：
1. **端口检测函数输出格式错误** - 导致 `docker: invalid containerPort` 错误
2. **脚本连接断开** - 可能是由于网络不稳定或命令执行失败

## 修复内容

### 1. 端口检测函数优化
- 修复了 `detect_database_port()` 函数的输出格式问题
- 修复了 `detect_backend_port()` 函数的输出格式问题  
- 修复了 `detect_frontend_port()` 函数的输出格式问题
- 确保端口检测函数只返回纯数字端口号，避免包含警告信息

### 2. 错误处理增强
- 为数据库端口检测添加了错误处理
- 简化了数据库修复脚本调用逻辑
- 移除了不必要的复杂性

### 3. 日志输出优化
- 清理了混乱的日志输出格式
- 确保端口信息显示正确
- 优化了步骤编号的逻辑

## 使用方法

直接使用修复后的 `deploy.sh` 脚本：

```bash
sudo bash deploy.sh
```

## 修复效果

修复后的脚本应该能够：
- 正确检测和分配可用端口
- 避免 Docker 端口参数错误
- 提供清晰的部署流程日志
- 更好的错误处理和恢复机制

## 关键改进点

1. **端口检测逻辑**：确保端口变量只包含数字，不包含任何日志信息
2. **错误边界**：为关键步骤添加错误检查，防止脚本在中间步骤失败
3. **简化流程**：移除不必要的复杂修复逻辑，专注于核心部署功能

如果仍然遇到问题，建议：
1. 检查系统资源（内存、磁盘空间）
2. 确认网络连接稳定
3. 检查是否有其他进程占用端口
4. 查看详细的错误日志信息 