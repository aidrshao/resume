# éƒ¨ç½²è„šæœ¬å¯¹æ¯”ï¼šdeploy.sh vs deploy_1.sh

## æ¦‚è¿°

| ç‰¹æ€§ | deploy.sh (åŸç‰ˆ) | deploy_1.sh (æ–°ç‰ˆ) |
|------|------------------|-------------------|
| ç‰ˆæœ¬ | v1.8.0 | v2.0.0 |
| ä¸»è¦é—®é¢˜ | ç«¯å£ä¸€è‡´æ€§é—®é¢˜ | ç«¯å£é—®é¢˜å·²è§£å†³ |
| éƒ¨ç½²æµç¨‹ | ä¸å¤Ÿç»“æ„åŒ– | 12æ­¥æ ‡å‡†åŒ–æµç¨‹ |
| é”™è¯¯å¤„ç† | åŸºç¡€é”™è¯¯å¤„ç† | å¢å¼ºé”™è¯¯å¤„ç† |

## ä¸»è¦æ”¹è¿›

### ğŸ”§ ç«¯å£ä¸€è‡´æ€§è§£å†³æ–¹æ¡ˆ

#### åŸç‰ˆé—®é¢˜
- ç«¯å£ç¡¬ç¼–ç åœ¨é…ç½®æ–‡ä»¶ä¸­
- å‰åç«¯ç«¯å£ä¸åŒæ­¥
- ç«¯å£å†²çªå¤„ç†ä¸å®Œå–„
- 504é”™è¯¯é¢‘å‘

#### æ–°ç‰ˆè§£å†³æ–¹æ¡ˆ
- æ™ºèƒ½ç«¯å£æ£€æµ‹å’Œåˆ†é…
- åŠ¨æ€é…ç½®æ–‡ä»¶ç”Ÿæˆ
- ç«¯å£ä¸€è‡´æ€§éªŒè¯
- è‡ªåŠ¨ç«¯å£å†²çªå¤„ç†

### ğŸ—ï¸ ç»“æ„åŒ–éƒ¨ç½²æµç¨‹

#### åŸç‰ˆç»“æ„
```
deploy.sh
â”œâ”€â”€ ç¯å¢ƒæ£€æŸ¥
â”œâ”€â”€ ä¾èµ–å®‰è£…
â”œâ”€â”€ æœåŠ¡é…ç½®
â””â”€â”€ å¯åŠ¨æœåŠ¡
```

#### æ–°ç‰ˆç»“æ„
```
deploy_1.sh
â”œâ”€â”€ 1. åˆå§‹åŒ–å’Œå‚æ•°è§£æ
â”œâ”€â”€ 2. ç³»ç»Ÿç¯å¢ƒæ£€æŸ¥
â”œâ”€â”€ 3. ä¾èµ–å®‰è£…
â”œâ”€â”€ 4. é¡¹ç›®å‡†å¤‡
â”œâ”€â”€ 5. ç«¯å£æ£€æµ‹ (æ–°å¢)
â”œâ”€â”€ 6. æ•°æ®åº“é…ç½®
â”œâ”€â”€ 7. Redisé…ç½®
â”œâ”€â”€ 8. ç»Ÿä¸€ç¯å¢ƒé…ç½® (æ”¹è¿›)
â”œâ”€â”€ 9. åç«¯æœåŠ¡é…ç½®
â”œâ”€â”€ 10. å‰ç«¯æœåŠ¡é…ç½®
â”œâ”€â”€ 11. Nginxé…ç½® (æ”¹è¿›)
â””â”€â”€ 12. æœ€ç»ˆéªŒè¯ (æ–°å¢)
```

### ğŸš€ éƒ¨ç½²æ¨¡å¼å¯¹æ¯”

#### åŸç‰ˆæ¨¡å¼
- å®Œæ•´éƒ¨ç½²
- ç´§æ€¥æ¢å¤æ¨¡å¼
- ç«¯å£åŒæ­¥ä¿®å¤æ¨¡å¼

#### æ–°ç‰ˆæ¨¡å¼
- å®Œæ•´éƒ¨ç½²ï¼ˆé»˜è®¤ï¼‰
- ä»…Nginxé…ç½® (`--nginx-only`)
- ä»…æ•°æ®åº“ä¿®å¤ (`--db-fix-only`)
- æ¸…ç†å®‰è£… (`--clean`)
- è‡ªå®šä¹‰ç«¯å£ (`--backend-port`, `--frontend-port`)

## æŠ€æœ¯æ”¹è¿›å¯¹æ¯”

### ç«¯å£æ£€æµ‹æœºåˆ¶

#### åŸç‰ˆ
```bash
# ç®€å•çš„ç«¯å£æ£€æµ‹
if netstat -tlnp | grep :8000; then
    echo "ç«¯å£è¢«å ç”¨"
fi
```

#### æ–°ç‰ˆ
```bash
# æ™ºèƒ½ç«¯å£æ£€æµ‹
check_port_usage() {
    local port=$1
    if lsof -Pi :$port -sTCP:LISTEN -t >/dev/null 2>&1; then
        return 0  # ç«¯å£è¢«å ç”¨
    else
        return 1  # ç«¯å£å¯ç”¨
    fi
}

find_available_port() {
    local start_port=$1
    for ((i=0; i<100; i++)); do
        local test_port=$((start_port + i))
        if ! check_port_usage $test_port; then
            echo $test_port
            return 0
        fi
    done
}
```

### é…ç½®æ–‡ä»¶ç”Ÿæˆ

#### åŸç‰ˆ
```bash
# é™æ€é…ç½®æ–‡ä»¶
cat > backend/.env << EOF
PORT=8000
EOF
```

#### æ–°ç‰ˆ
```bash
# åŠ¨æ€é…ç½®æ–‡ä»¶
cat > backend/.env << EOF
PORT=$FINAL_BACKEND_PORT
DB_PORT=$FINAL_DB_PORT
REDIS_PORT=$FINAL_REDIS_PORT
EOF
```

### Nginxé…ç½®

#### åŸç‰ˆ
```nginx
# ç¡¬ç¼–ç ç«¯å£
upstream backend_api {
    server 127.0.0.1:8000;
}
```

#### æ–°ç‰ˆ
```nginx
# åŠ¨æ€ç«¯å£é…ç½®
upstream backend_api {
    server 127.0.0.1:$FINAL_BACKEND_PORT;
}
```

## é”™è¯¯å¤„ç†å¯¹æ¯”

### åŸç‰ˆé”™è¯¯å¤„ç†
- åŸºç¡€çš„é”™è¯¯æ•è·
- ç®€å•çš„æ—¥å¿—è®°å½•
- æœ‰é™çš„æ¢å¤æœºåˆ¶

### æ–°ç‰ˆé”™è¯¯å¤„ç†
- å®Œæ•´çš„é”™è¯¯å¤„ç†é“¾
- è¯¦ç»†çš„æ—¥å¿—è®°å½•
- å¤šå±‚æ¬¡çš„æ¢å¤æœºåˆ¶
- æœåŠ¡å¥åº·æ£€æŸ¥

## æ€§èƒ½ä¼˜åŒ–å¯¹æ¯”

### å†…å­˜ç®¡ç†

#### åŸç‰ˆ
```bash
npm install
npm run build
```

#### æ–°ç‰ˆ
```bash
export NODE_OPTIONS="--max-old-space-size=2048"
npm install --production
npm run build
```

### å¹¶å‘å¤„ç†

#### åŸç‰ˆ
- ä¸²è¡Œæ‰§è¡Œæ‰€æœ‰æ­¥éª¤
- æ— å¹¶å‘ä¼˜åŒ–

#### æ–°ç‰ˆ
- ä¼˜åŒ–çš„æ‰§è¡Œé¡ºåº
- å†…å­˜ç›‘æ§
- èµ„æºæ£€æŸ¥

## æ—¥å¿—å’Œç›‘æ§å¯¹æ¯”

### æ—¥å¿—è®°å½•

#### åŸç‰ˆ
- åŸºç¡€çš„æ§åˆ¶å°è¾“å‡º
- ç®€å•çš„é”™è¯¯è®°å½•

#### æ–°ç‰ˆ
- ç»Ÿä¸€çš„æ—¥å¿—ç³»ç»Ÿ
- è¯¦ç»†çš„æ­¥éª¤è®°å½•
- å½©è‰²è¾“å‡º
- æ—¥å¿—æ–‡ä»¶æŒä¹…åŒ–

### ç›‘æ§åŠŸèƒ½

#### åŸç‰ˆ
- åŸºç¡€çš„æœåŠ¡çŠ¶æ€æ£€æŸ¥

#### æ–°ç‰ˆ
- å…¨é¢çš„æœåŠ¡è¯Šæ–­
- ç«¯å£ç›‘å¬æ£€æŸ¥
- å¥åº·çŠ¶æ€éªŒè¯
- é…ç½®ä¸€è‡´æ€§éªŒè¯

## ç”¨æˆ·ä½“éªŒå¯¹æ¯”

### å‘½ä»¤è¡Œå‚æ•°

#### åŸç‰ˆ
```bash
sudo bash deploy.sh
sudo bash deploy.sh --mode=clean
```

#### æ–°ç‰ˆ
```bash
sudo bash deploy_1.sh
sudo bash deploy_1.sh --nginx-only
sudo bash deploy_1.sh --db-fix-only
sudo bash deploy_1.sh --clean
sudo bash deploy_1.sh --backend-port=8001
sudo bash deploy_1.sh --help
```

### æˆåŠŸä¿¡æ¯æ˜¾ç¤º

#### åŸç‰ˆ
- ç®€å•çš„æˆåŠŸæç¤º
- åŸºç¡€çš„è®¿é—®ä¿¡æ¯

#### æ–°ç‰ˆ
- å®Œæ•´çš„éƒ¨ç½²æ‘˜è¦
- è¯¦ç»†çš„æœåŠ¡ä¿¡æ¯
- ç®¡ç†å‘½ä»¤æŒ‡å—
- æ•…éšœæ’é™¤æŒ‡å—

## å…¼å®¹æ€§å¯¹æ¯”

### ç³»ç»Ÿæ”¯æŒ

#### åŸç‰ˆ
- Ubuntu/Debianæ”¯æŒ
- åŸºç¡€çš„CentOSæ”¯æŒ

#### æ–°ç‰ˆ
- Ubuntu 18.04+
- Debian 10+
- CentOS 7+
- RHEL 7+

### å‘åå…¼å®¹æ€§

#### åŸç‰ˆ
- ä¸æ—©æœŸç‰ˆæœ¬å…¼å®¹

#### æ–°ç‰ˆ
- ä¸åŸé¡¹ç›®ç»“æ„å…¼å®¹
- æ”¯æŒç°æœ‰é…ç½®æ–‡ä»¶
- å¯åœ¨ç°æœ‰éƒ¨ç½²åŸºç¡€ä¸Šå‡çº§

## è¿ç§»å»ºè®®

### ä»deploy.shè¿ç§»åˆ°deploy_1.sh

1. **å¤‡ä»½ç°æœ‰é…ç½®**
   ```bash
   cp backend/.env backend/.env.backup
   cp frontend/.env frontend/.env.backup
   ```

2. **ä½¿ç”¨æ–°è„šæœ¬éƒ¨ç½²**
   ```bash
   sudo bash deploy_1.sh
   ```

3. **éªŒè¯æœåŠ¡çŠ¶æ€**
   ```bash
   pm2 list
   docker ps
   curl http://localhost/health
   ```

### è¿ç§»æ³¨æ„äº‹é¡¹

- æ–°è„šæœ¬ä¼šè‡ªåŠ¨æ£€æµ‹ç°æœ‰æœåŠ¡
- ç«¯å£å¯èƒ½ä¼šå‘ç”Ÿå˜åŒ–
- éœ€è¦é‡æ–°é…ç½®åŸŸåè§£æï¼ˆå¦‚æœæœ‰ï¼‰
- å»ºè®®åœ¨æµ‹è¯•ç¯å¢ƒå…ˆéªŒè¯

## æ€»ç»“

deploy_1.sh æ˜¯å¯¹åŸæœ‰éƒ¨ç½²è„šæœ¬çš„å…¨é¢å‡çº§ï¼Œä¸»è¦è§£å†³äº†ç«¯å£ä¸€è‡´æ€§é—®é¢˜ï¼Œæä¾›äº†æ›´å¥½çš„ç”¨æˆ·ä½“éªŒå’Œæ›´å¼ºçš„é”™è¯¯å¤„ç†èƒ½åŠ›ã€‚å»ºè®®åœ¨ç”Ÿäº§ç¯å¢ƒä¸­ä½¿ç”¨æ–°ç‰ˆè„šæœ¬è¿›è¡Œéƒ¨ç½²ã€‚

---

**æ¨èä½¿ç”¨**: deploy_1.sh æä¾›æ›´å¥½çš„ç¨³å®šæ€§å’Œç”¨æˆ·ä½“éªŒ 