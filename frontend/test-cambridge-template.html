<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å‰‘æ¡¥ç»å…¸æ¨¡æ¿æµ‹è¯•</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            margin: 20px;
            background-color: #f5f5f5;
        }
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .section {
            margin-bottom: 20px;
            padding: 15px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
        .btn {
            background: #007bff;
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .btn:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            padding: 10px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 12px;
            max-height: 150px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        #preview {
            border: 2px solid #ddd;
            min-height: 600px;
            padding: 20px;
            background: white;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>å‰‘æ¡¥ç»å…¸æ¨¡æ¿æµ‹è¯•</h1>
        
        <div class="section">
            <h3>æµ‹è¯•æ­¥éª¤</h3>
            <button class="btn" onclick="loadAndRender()">åŠ è½½å¹¶æ¸²æŸ“å‰‘æ¡¥ç»å…¸æ¨¡æ¿</button>
            <button class="btn" onclick="clearLog()">æ¸…ç©ºæ—¥å¿—</button>
        </div>

        <div class="section">
            <h3>æ—¥å¿—</h3>
            <div id="log" class="log">å‡†å¤‡æµ‹è¯•å‰‘æ¡¥ç»å…¸æ¨¡æ¿...\n</div>
        </div>

        <div class="section">
            <h3>é¢„è§ˆ</h3>
            <div id="preview">ç­‰å¾…åŠ è½½æ¨¡æ¿...</div>
        </div>
    </div>

    <!-- å¼•å…¥Handlebars -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/handlebars.js/4.7.7/handlebars.min.js"></script>

    <script>
        // æ³¨å†Œreplace helper
        Handlebars.registerHelper('replace', function(str, find) {
            console.log('ğŸ”„ [replace helper] å¤„ç†æ–‡æœ¬:', { str: typeof str, find });
            
            if (typeof str !== 'string') {
                console.log('âš ï¸ [replace helper] è¾“å…¥ä¸æ˜¯å­—ç¬¦ä¸²ï¼Œè¿”å›ç©ºå­—ç¬¦ä¸²');
                return '';
            }
            
            const parts = str.split(find);
            const filteredParts = parts.filter(part => part.trim() !== '');
            const result = filteredParts.map(part => `<p>${part}</p>`).join('');
            
            console.log('âœ… [replace helper] è½¬æ¢å®Œæˆ:', {
                åŸå§‹æ–‡æœ¬é•¿åº¦: str.length,
                åˆ†å‰²ç‰‡æ®µæ•°: parts.length,
                è¿‡æ»¤åç‰‡æ®µæ•°: filteredParts.length,
                ç»“æœé•¿åº¦: result.length
            });
            
            return new Handlebars.SafeString(result);
        });

        // æ—¥å¿—å‡½æ•°
        function log(message) {
            const logElement = document.getElementById('log');
            const timestamp = new Date().toLocaleTimeString();
            logElement.textContent += `[${timestamp}] ${message}\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(message);
        }

        function clearLog() {
            document.getElementById('log').textContent = 'æ—¥å¿—å·²æ¸…ç©º...\n';
        }

        // æµ‹è¯•æ•°æ®
        const testResumeData = {
            profile: {
                name: "å¼ ä¸‰",
                email: "zhangsan@test.com",
                phone: "13800138000",
                location: "åŒ—äº¬å¸‚",
                summary: "ä¸“æ³¨äºå‰ç«¯æŠ€æœ¯çš„é«˜çº§å·¥ç¨‹å¸ˆï¼Œå…·æœ‰5å¹´Reactå¼€å‘ç»éªŒã€‚"
            },
            workExperience: [
                {
                    position: "é«˜çº§å‰ç«¯å¼€å‘å·¥ç¨‹å¸ˆ",
                    company: "ABCç§‘æŠ€å…¬å¸",
                    duration: "2021-2024",
                    description: "è´Ÿè´£å¤§å‹Reacté¡¹ç›®çš„æ¶æ„è®¾è®¡å’Œå¼€å‘\nä½¿ç”¨TypeScriptæ„å»ºç±»å‹å®‰å…¨çš„å‰ç«¯åº”ç”¨\né…åˆåç«¯å›¢é˜Ÿå®ŒæˆNode.js APIå¼€å‘\næŒ‡å¯¼åˆçº§å¼€å‘äººå‘˜è¿›è¡ŒæŠ€æœ¯æå‡"
                }
            ],
            projectExperience: [
                {
                    name: "ä¼ä¸šçº§ç®¡ç†ç³»ç»Ÿ",
                    duration: "2023-2024",
                    role: "å‰ç«¯æŠ€æœ¯è´Ÿè´£äºº",
                    description: "åŸºäºReact + TypeScriptæ„å»ºçš„å¤§å‹ä¼ä¸šç®¡ç†ç³»ç»Ÿ\næ”¯æŒå¤šç§Ÿæˆ·æ¶æ„\nå®ç°äº†å¤æ‚çš„æƒé™ç®¡ç†ç³»ç»Ÿ"
                }
            ],
            education: [
                {
                    school: "åŒ—äº¬å¤§å­¦",
                    degree: "æœ¬ç§‘",
                    major: "è®¡ç®—æœºç§‘å­¦ä¸æŠ€æœ¯",
                    duration: "2017-2021"
                }
            ],
            skills: [
                {
                    category: "æ ¸å¿ƒæŠ€æœ¯",
                    details: "React, TypeScript, JavaScript ES6+, HTML5, CSS3"
                },
                {
                    category: "å¼€å‘å·¥å…·",
                    details: "Node.js, Webpack, Vite, Git, Docker"
                }
            ],
            customSections: [
                {
                    title: "è·å¥–ç»å†",
                    content: "2023å¹´åº¦æœ€ä½³å‘˜å·¥\nå…¬å¸æŠ€æœ¯åˆ›æ–°å¥–\nå›¢é˜Ÿåä½œæ°å‡ºè´¡çŒ®å¥–"
                }
            ]
        };

        // åŠ è½½å¹¶æ¸²æŸ“æ¨¡æ¿
        async function loadAndRender() {
            log('ğŸ¨ å¼€å§‹åŠ è½½å‰‘æ¡¥ç»å…¸æ¨¡æ¿...');
            
            try {
                // è·å–æ¨¡æ¿
                const response = await fetch('http://localhost:8001/api/templates/5');
                const data = await response.json();
                
                if (!data.success) {
                    log(`âŒ æ¨¡æ¿åŠ è½½å¤±è´¥: ${data.message}`);
                    return;
                }
                
                const template = data.data;
                log(`âœ… æ¨¡æ¿åŠ è½½æˆåŠŸ: ${template.name}`);
                log(`ğŸ“ HTMLé•¿åº¦: ${template.html_content.length}`);
                log(`ğŸ¨ CSSé•¿åº¦: ${template.css_content.length}`);
                
                // æ¸…ç†ä¹‹å‰çš„æ ·å¼
                const existingStyles = document.querySelectorAll('style[data-template-id]');
                existingStyles.forEach(style => style.remove());
                
                // ç¼–è¯‘å¹¶æ¸²æŸ“
                log('ğŸ”§ ç¼–è¯‘HTMLæ¨¡æ¿...');
                const htmlTemplate = Handlebars.compile(template.html_content);
                
                log('ğŸ¯ ç”ŸæˆHTMLå†…å®¹...');
                const finalHtml = htmlTemplate(testResumeData);
                
                // æ¸²æŸ“åˆ°é¢„è§ˆåŒº
                const previewElement = document.getElementById('preview');
                previewElement.innerHTML = finalHtml;
                
                // åº”ç”¨CSSæ ·å¼
                if (template.css_content) {
                    log('ğŸ¨ åº”ç”¨CSSæ ·å¼...');
                    const styleElement = document.createElement('style');
                    styleElement.textContent = template.css_content;
                    styleElement.setAttribute('data-template-id', template.id);
                    document.head.appendChild(styleElement);
                }
                
                log('âœ… å‰‘æ¡¥ç»å…¸æ¨¡æ¿æ¸²æŸ“å®Œæˆï¼');
                
            } catch (error) {
                log(`âŒ æ¸²æŸ“å¤±è´¥: ${error.message}`);
                console.error('æ¸²æŸ“é”™è¯¯è¯¦æƒ…:', error);
            }
        }

        // é¡µé¢åŠ è½½å®Œæˆ
        window.onload = function() {
            log('ğŸ“± æµ‹è¯•é¡µé¢åŠ è½½å®Œæˆ');
            log('ğŸ’¡ ç‚¹å‡»æŒ‰é’®å¼€å§‹æµ‹è¯•å‰‘æ¡¥ç»å…¸æ¨¡æ¿');
        };
    </script>
</body>
</html> 