# Deploy_1.sh 一键部署脚本使用指南

## 概述

`deploy_1.sh` 是为AI俊才社简历系统专门定制的一键部署脚本，解决了原有部署脚本的端口一致性问题，提供了完整的12步部署流程。

## 主要特点

### 🔧 端口一致性解决方案
- **智能端口检测**: 自动检测可用端口，避免端口冲突
- **端口同步机制**: 确保前后端、数据库、Redis等服务端口一致
- **动态配置生成**: 根据检测到的端口动态生成配置文件

### 🏗️ 完整的12步部署流程

1. **初始化和参数解析** - 脚本头部信息、权限检查、日志记录
2. **系统环境检查** - 操作系统兼容性、系统资源、网络连接
3. **依赖安装** - Node.js、Docker、PM2、系统工具
4. **项目准备** - 代码准备、目录权限、备份恢复
5. **端口检测** - 智能端口检测、一致性验证
6. **数据库配置** - PostgreSQL容器、扩展、权限设置
7. **Redis配置** - Redis容器、密码生成、连接验证
8. **环境配置** - 后端/前端环境变量、配置文件生成
9. **后端服务** - 依赖安装、数据库迁移、PM2启动
10. **前端服务** - 构建优化、内存监控、服务启动
11. **Nginx配置** - 反向代理、负载均衡、SSL准备
12. **最终验证** - 健康检查、服务诊断、成功信息

### 🚀 部署模式

- **完整部署** (`默认`): 执行全部12个步骤
- **仅Nginx配置** (`--nginx-only`): 只配置Nginx反向代理
- **仅数据库修复** (`--db-fix-only`): 只修复数据库问题
- **清理安装** (`--clean`): 清理后重新安装

## 使用方法

### 基本用法

```bash
# 完整部署
sudo bash deploy_1.sh

# 显示帮助信息
sudo bash deploy_1.sh --help
```

### 高级用法

```bash
# 仅配置Nginx
sudo bash deploy_1.sh --nginx-only

# 仅修复数据库
sudo bash deploy_1.sh --db-fix-only

# 清理重装
sudo bash deploy_1.sh --clean

# 指定端口
sudo bash deploy_1.sh --backend-port=8001 --frontend-port=3017
```

## 端口配置

### 默认端口
- 后端服务: `8000`
- 前端服务: `3016`
- 数据库: `5434`
- Redis: `6379`
- Nginx: `80`

### 端口冲突处理
脚本会自动检测端口冲突，并按以下策略处理：
1. 检测端口是否被占用
2. 如果被我们的服务占用，继续使用
3. 如果被其他服务占用，自动寻找下一个可用端口
4. 更新所有相关配置文件以保持一致性

## 系统要求

### 支持的操作系统
- Ubuntu 18.04+
- Debian 10+
- CentOS 7+
- RHEL 7+

### 系统资源
- 内存: 至少1GB，推荐2GB+
- 磁盘: 至少5GB可用空间
- 网络: 能够访问外网下载依赖

## 部署后配置

### 必要配置
1. **AI API密钥** (后端.env文件)
   ```
   OPENAI_API_KEY=your-api-key
   DEEPSEEK_API_KEY=your-api-key
   ```

2. **邮件服务** (后端.env文件)
   ```
   TENCENT_SECRET_ID=your-secret-id
   TENCENT_SECRET_KEY=your-secret-key
   ```

### 可选配置
- 域名和SSL证书
- 数据库备份策略
- 监控和日志轮转

## 故障排除

### 常见问题

1. **端口冲突**
   ```bash
   # 检查端口占用
   netstat -tlnp | grep :8000
   
   # 重新部署
   sudo bash deploy_1.sh
   ```

2. **服务启动失败**
   ```bash
   # 查看PM2状态
   pm2 list
   
   # 查看日志
   pm2 logs
   ```

3. **Nginx配置问题**
   ```bash
   # 仅重新配置Nginx
   sudo bash deploy_1.sh --nginx-only
   
   # 测试Nginx配置
   nginx -t
   ```

### 日志文件
- 部署日志: `/var/log/deploy_resume.log`
- 后端日志: `/home/ubuntu/resume/backend/logs/`
- PM2日志: `pm2 logs`

## 与原版deploy.sh的区别

### 主要改进
1. **端口一致性**: 解决了端口硬编码和不同步问题
2. **模块化设计**: 12步清晰的部署流程
3. **错误处理**: 更好的错误检测和恢复机制
4. **智能检测**: 自动检测现有服务和端口占用
5. **详细日志**: 完整的部署过程记录

### 向后兼容性
- 保持与原项目结构的兼容性
- 支持现有的配置文件格式
- 可以在现有部署基础上升级

## 技术架构

### 服务架构
```
[用户请求] → [Nginx:80] → [前端:3016] / [后端API:8000]
                                          ↓
[PostgreSQL:5434] ← [后端服务] → [Redis:6379]
```

### 进程管理
- **PM2**: 管理Node.js应用
- **Docker**: 管理数据库和Redis
- **Systemd**: 管理系统服务

## 更新日志

### v2.0.0 (2025-01-09)
- 重新设计端口检测机制
- 实现12步部署流程
- 添加多种部署模式
- 改进错误处理和日志记录
- 增强系统兼容性

## 支持和反馈

如果在使用过程中遇到问题，请：
1. 查看部署日志: `cat /var/log/deploy_resume.log`
2. 检查服务状态: `pm2 list && docker ps`
3. 尝试重新部署: `sudo bash deploy_1.sh`

---

**注意**: 此脚本需要root权限运行，请确保在生产环境中谨慎使用。 