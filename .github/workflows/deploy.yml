name: Safe Deploy to Server

# è§¦å‘æ¡ä»¶ï¼šæ¨é€åˆ°mainåˆ†æ”¯æ—¶è‡ªåŠ¨éƒ¨ç½²
on:
  push:
    branches: [ main ]
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘

jobs:
  deploy:
    runs-on: ubuntu-latest
    
    # æ·»åŠ éƒ¨ç½²ç¯å¢ƒä¿æŠ¤
    environment: production
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        fetch-depth: 0  # ç¡®ä¿è·å–å®Œæ•´gitå†å²
    
    - name: ç”Ÿæˆå”¯ä¸€éƒ¨ç½²IDå’Œé¡¹ç›®å‰ç¼€
      run: |
        echo "DEPLOY_ID=resume-$(date +%Y%m%d-%H%M%S)" >> $GITHUB_ENV
        echo "PROJECT_PREFIX=$(echo '${{ github.repository }}' | md5sum | cut -c1-8)" >> $GITHUB_ENV
        echo "FRONTEND_PORT=3016" >> $GITHUB_ENV
        echo "BACKEND_PORT=8016" >> $GITHUB_ENV
    
    - name: éªŒè¯ç¯å¢ƒå’ŒSecrets
      run: |
        # æ£€æŸ¥å¿…è¦çš„Secretsï¼ˆé€ä¸€é™æ€æ£€æŸ¥ï¼‰
        echo "ğŸ” éªŒè¯GitHub Secretsé…ç½®..."
        
        # æ£€æŸ¥AGICTO_API_KEY
        if [ -z "${{ secrets.AGICTO_API_KEY }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: AGICTO_API_KEY"
          exit 1
        fi
        
        # æ£€æŸ¥TENCENT_SECRET_ID
        if [ -z "${{ secrets.TENCENT_SECRET_ID }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: TENCENT_SECRET_ID"
          exit 1
        fi
        
        # æ£€æŸ¥TENCENT_SECRET_KEY
        if [ -z "${{ secrets.TENCENT_SECRET_KEY }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: TENCENT_SECRET_KEY"
          exit 1
        fi
        
        # æ£€æŸ¥DB_PASSWORD
        if [ -z "${{ secrets.DB_PASSWORD }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: DB_PASSWORD"
          exit 1
        fi
        
        # æ£€æŸ¥JWT_SECRET
        if [ -z "${{ secrets.JWT_SECRET }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: JWT_SECRET"
          exit 1
        fi
        
        # æ£€æŸ¥HOST
        if [ -z "${{ secrets.HOST }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: HOST"
          exit 1
        fi
        
        # æ£€æŸ¥USERNAME
        if [ -z "${{ secrets.USERNAME }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: USERNAME"
          exit 1
        fi
        
        # æ£€æŸ¥PRIVATE_KEY
        if [ -z "${{ secrets.PRIVATE_KEY }}" ]; then
          echo "âŒ ç¼ºå°‘å¿…è¦Secret: PRIVATE_KEY"
          exit 1
        fi

        echo "âœ… æ‰€æœ‰å¿…è¦çš„Secretså·²é…ç½®å®Œæˆ"
    
    - name: éªŒè¯SSHè¿é€šæ€§
      run: |
        # åˆ›å»ºä¸´æ—¶SSHå¯†é’¥æ–‡ä»¶
        echo "${{ secrets.PRIVATE_KEY }}" > /tmp/ssh_key
        chmod 600 /tmp/ssh_key
        
        # æµ‹è¯•SSHè¿æ¥
        ssh -o StrictHostKeyChecking=no -o ConnectTimeout=10 \
          -i /tmp/ssh_key \
          ${{ secrets.USERNAME }}@${{ secrets.HOST }} \
          "echo 'SSHè¿æ¥æˆåŠŸ'" || (echo "âŒ SSHè¿æ¥å¤±è´¥"; exit 1)
        
        # æ¸…ç†ä¸´æ—¶æ–‡ä»¶
        rm -f /tmp/ssh_key
    
    - name: è®¾ç½®Node.jsç¯å¢ƒ
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: |
          backend/package-lock.json
          frontend/package-lock.json
    
    - name: å®‰è£…ä¾èµ–å¹¶å®‰å…¨æ‰«æ
      run: |
        cd backend && npm ci
        cd ../frontend && npm ci
        
        # å®‰å…¨æ‰«æ
        cd ../backend && npm audit --audit-level=moderate || echo "âš ï¸ å‘ç°å®‰å…¨è­¦å‘Š"
        cd ../frontend && npm audit --audit-level=moderate || echo "âš ï¸ å‘ç°å®‰å…¨è­¦å‘Š"
    
    - name: æ„å»ºå‰ç«¯
      run: |
        cd frontend
        npm run build
    
    - name: åˆ›å»ºå®‰å…¨éš”ç¦»éƒ¨ç½²åŒ…
      run: |
        mkdir -p deploy/{backend,frontend,scripts}
        
        # å¤åˆ¶æ–‡ä»¶ï¼ˆæ’é™¤æ•æ„Ÿæ–‡ä»¶ï¼‰
        cp -r backend/* deploy/backend/
        rm -rf deploy/backend/{node_modules,.env*,test,coverage}
        cp -r frontend/build/* deploy/frontend/

        # ç”Ÿæˆå®‰å…¨éš”ç¦»éƒ¨ç½²è„šæœ¬
        cat > deploy/scripts/deploy.sh << 'DEPLOY_EOF'
        #!/bin/bash
        set -euo pipefail

        # åŠ¨æ€å˜é‡ï¼ˆä»GitHub Actionsä¼ é€’ï¼‰
        readonly PROJECT_NAME="resume-system"
        readonly DEPLOY_ID="$1"
        readonly PROJECT_PREFIX="$2"
        readonly FRONTEND_PORT="$3"
        readonly BACKEND_PORT="$4"
        readonly DEPLOY_USER=$(whoami)
        readonly APP_DIR="/home/$DEPLOY_USER/$PROJECT_NAME-$DEPLOY_ID"
        readonly LOG_FILE="/var/log/${PROJECT_NAME}-${DEPLOY_ID}.log"
        readonly BACKUP_DIR="/home/$DEPLOY_USER/backup/${PROJECT_NAME}-$(date +%Y%m%d_%H%M%S)"

        # ç¡®ä¿æ—¥å¿—æ–‡ä»¶å­˜åœ¨
        sudo touch "$LOG_FILE"
        sudo chown "$DEPLOY_USER:$DEPLOY_USER" "$LOG_FILE"

        # æ—¥å¿—å‡½æ•°
        log() {
          echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1" | tee -a "$LOG_FILE"
        }

        # æ¸…ç†å‡½æ•°
        cleanup_on_error() {
          log "âŒ éƒ¨ç½²å¤±è´¥ï¼Œå¼€å§‹æ¸…ç†..."
          
          # åœæ­¢å¯èƒ½å¯åŠ¨çš„æœåŠ¡
          pm2 delete "${PROJECT_PREFIX}-backend" 2>/dev/null || true
          pm2 delete "${PROJECT_PREFIX}-frontend" 2>/dev/null || true
          
          # æ¸…ç†ä¸´æ—¶ç›®å½•
          rm -rf "$APP_DIR" 2>/dev/null || true
          
          log "ğŸ§¹ æ¸…ç†å®Œæˆ"
          exit 1
        }

        # è®¾ç½®é”™è¯¯å¤„ç†
        trap cleanup_on_error ERR

        # å®‰å…¨é¢„æ£€å‡½æ•°
        safe_precheck() {
          log "ğŸ” å¼€å§‹å®‰å…¨é¢„æ£€ (éƒ¨ç½²ID: $DEPLOY_ID)"

          # 1. æ£€æŸ¥ç³»ç»Ÿèµ„æº
          local available_space=$(df --output=avail / | tail -1)
          [ $available_space -lt 3145728 ] && { 
            log "âŒ ç£ç›˜ç©ºé—´ä¸è¶³ï¼Œéœ€è¦è‡³å°‘3GB"; 
            exit 1; 
          }

          local available_memory=$(free -m | awk '/Mem:/ {print $7}')
          [ $available_memory -lt 1024 ] && { 
            log "âš ï¸  å¯ç”¨å†…å­˜è¾ƒä½: ${available_memory}MB"; 
          }

          # 2. æ£€æŸ¥å…³é”®ç«¯å£æ˜¯å¦è¢«å ç”¨
          check_port() {
            local port=$1
            local service=$2
            if lsof -i :$port >/dev/null 2>&1; then
              local process=$(lsof -i :$port | grep LISTEN | head -1)
              log "âŒ ç«¯å£ $port ($service) è¢«å ç”¨: $process"
              return 1
            fi
            log "âœ… ç«¯å£ $port ($service) å¯ç”¨"
            return 0
          }

          check_port $FRONTEND_PORT "å‰ç«¯æœåŠ¡" || exit 1
          check_port $BACKEND_PORT "åç«¯API" || exit 1

          # 3. æ£€æŸ¥Dockerå®¹å™¨å‘½åå†²çª
          local db_container="${PROJECT_PREFIX}-postgres"
          if docker ps -a --format '{{.Names}}' | grep -q "^${db_container}$"; then
            log "âš ï¸  å‘ç°åŒåDockerå®¹å™¨: $db_container"
            log "ğŸ”§ å°†é‡ç”¨ç°æœ‰å®¹å™¨ï¼ˆç¡®ä¿æ•°æ®å®‰å…¨ï¼‰"
            USE_EXISTING_DB=true
          else
            USE_EXISTING_DB=false
          fi

          # 4. æ£€æŸ¥PM2è¿›ç¨‹å‘½åå†²çª
          if pm2 list | grep -q "${PROJECT_PREFIX}-backend"; then
            log "âš ï¸  å‘ç°åŒåPM2è¿›ç¨‹ï¼Œå°†å…ˆåœæ­¢æ—§è¿›ç¨‹"
            pm2 delete "${PROJECT_PREFIX}-backend" || true
          fi
          if pm2 list | grep -q "${PROJECT_PREFIX}-frontend"; then
            log "âš ï¸  å‘ç°åŒåPM2è¿›ç¨‹ï¼Œå°†å…ˆåœæ­¢æ—§è¿›ç¨‹"
            pm2 delete "${PROJECT_PREFIX}-frontend" || true
          fi

          # 5. æ£€æŸ¥Nginxé…ç½®å†²çª
          if [ -f "/etc/nginx/sites-enabled/${PROJECT_PREFIX}-resume.conf" ]; then
            log "âš ï¸  å‘ç°ç°æœ‰Nginxé…ç½®ï¼Œå°†æ›´æ–°é…ç½®"
          fi

          log "âœ… å®‰å…¨é¢„æ£€é€šè¿‡"
        }

        # å¤‡ä»½ç°æœ‰éƒ¨ç½²
        backup_existing() {
          local old_app_dir="/home/$DEPLOY_USER/$PROJECT_NAME"
          if [ -d "$old_app_dir" ]; then
            log "ğŸ“¦ å¤‡ä»½ç°æœ‰éƒ¨ç½²åˆ°: $BACKUP_DIR"
            mkdir -p "$BACKUP_DIR"
            cp -r "$old_app_dir" "$BACKUP_DIR/" || true
            
            # å¤‡ä»½æ•°æ®åº“
            local db_container="${PROJECT_PREFIX}-postgres"
            if docker ps --format '{{.Names}}' | grep -q "^${db_container}$"; then
              log "ğŸ’¾ å¤‡ä»½æ•°æ®åº“..."
              docker exec "$db_container" pg_dump \
                -U "${PROJECT_PREFIX}_resume_user" \
                "${PROJECT_PREFIX}_resume_db" > "$BACKUP_DIR/database_backup.sql" 2>/dev/null || true
            fi
          fi
        }

        # æ•°æ®åº“è®¾ç½®
        setup_database() {
          log "ğŸ˜ é…ç½®PostgreSQLæ•°æ®åº“..."
          
          local db_container="${PROJECT_PREFIX}-postgres"
          local db_network="${PROJECT_PREFIX}-network"
          local db_volume="${PROJECT_PREFIX}-pgdata"
          
          # åˆ›å»ºç‹¬ç«‹ç½‘ç»œ
          docker network create "$db_network" 2>/dev/null || log "ç½‘ç»œ $db_network å·²å­˜åœ¨"
          
          if [ "$USE_EXISTING_DB" = "false" ]; then
            log "ğŸš€ å¯åŠ¨æ–°çš„æ•°æ®åº“å®¹å™¨..."
            
            # ç”Ÿæˆéšæœºç«¯å£é¿å…å†²çª
            local db_port=$(shuf -i 5432-5532 -n 1)
            while lsof -i :$db_port >/dev/null 2>&1; do
              db_port=$(shuf -i 5432-5532 -n 1)
            done
            
            docker run -d \
              --name "$db_container" \
              --network "$db_network" \
              --restart unless-stopped \
              -e POSTGRES_DB="${PROJECT_PREFIX}_resume_db" \
              -e POSTGRES_USER="${PROJECT_PREFIX}_resume_user" \
              -e POSTGRES_PASSWORD="$DB_PASSWORD" \
              -p "127.0.0.1:$db_port:5432" \
              -v "$db_volume:/var/lib/postgresql/data" \
              postgres:15-alpine
            
            # ç­‰å¾…æ•°æ®åº“å¯åŠ¨
            log "â³ ç­‰å¾…æ•°æ®åº“å¯åŠ¨..."
            local max_attempts=30
            local attempt=1
            while [ $attempt -le $max_attempts ]; do
              if docker exec "$db_container" pg_isready -U "${PROJECT_PREFIX}_resume_user"; then
                log "âœ… æ•°æ®åº“å¯åŠ¨æˆåŠŸ"
                break
              fi
              log "â³ æ•°æ®åº“å¯åŠ¨ä¸­... ($attempt/$max_attempts)"
              sleep 2
              ((attempt++))
            done
            
            if [ $attempt -gt $max_attempts ]; then
              log "âŒ æ•°æ®åº“å¯åŠ¨å¤±è´¥"
              exit 1
            fi
          else
            log "âœ… é‡ç”¨ç°æœ‰æ•°æ®åº“å®¹å™¨"
          fi
        }

        # éƒ¨ç½²åº”ç”¨
        deploy_application() {
          log "ğŸ“‚ éƒ¨ç½²åº”ç”¨æ–‡ä»¶..."
          
          # åˆ›å»ºéš”ç¦»çš„åº”ç”¨ç›®å½•
          mkdir -p "$APP_DIR"/{backend,frontend}
          
          # å¤åˆ¶æ–‡ä»¶
          cp -r backend/* "$APP_DIR/backend/"
          cp -r frontend/* "$APP_DIR/frontend/"
          
          # è®¾ç½®æƒé™
          chown -R "$DEPLOY_USER:$DEPLOY_USER" "$APP_DIR"
          chmod -R 755 "$APP_DIR"
          
          # å®‰è£…åç«¯ä¾èµ–
          log "ğŸ“¦ å®‰è£…åç«¯ä¾èµ–..."
          cd "$APP_DIR/backend"
          npm ci --production --no-audit
          
          # ç”Ÿæˆéš”ç¦»çš„ç¯å¢ƒé…ç½®
          log "âš™ï¸  é…ç½®ç¯å¢ƒå˜é‡..."
          cat > "$APP_DIR/backend/.env" << ENV_EOF
        NODE_ENV=production
        PORT=$BACKEND_PORT

        # æ•°æ®åº“é…ç½®ï¼ˆä½¿ç”¨éš”ç¦»å‘½åï¼‰
        DB_HOST=127.0.0.1
        DB_PORT=5432
        DB_NAME=${PROJECT_PREFIX}_resume_db
        DB_USER=${PROJECT_PREFIX}_resume_user
        DB_PASS=$DB_PASSWORD

        # JWTå¯†é’¥
        JWT_SECRET=$JWT_SECRET

        # AI APIé…ç½®ï¼ˆä½¿ç”¨agictoä»£ç†ï¼‰
        AGICTO_API_KEY=$AGICTO_API_KEY
        OPENAI_BASE_URL=https://api.agicto.cn/v1

        # è…¾è®¯äº‘é‚®ä»¶æœåŠ¡é…ç½®
        TENCENT_SECRET_ID=$TENCENT_SECRET_ID
        TENCENT_SECRET_KEY=$TENCENT_SECRET_KEY
        TENCENT_SES_TEMPLATE_ID=31516
        TENCENT_SES_FROM_EMAIL=admin@juncaishe.com
        TENCENT_SES_FROM_NAME=AIä¿Šæ‰ç¤¾
        ENV_EOF
          
          chmod 600 "$APP_DIR/backend/.env"
          
          # è¿è¡Œæ•°æ®åº“è¿ç§»
          log "ğŸ”„ è¿è¡Œæ•°æ®åº“è¿ç§»..."
          npm run migrate || log "âš ï¸ è¿ç§»å¯èƒ½å·²å­˜åœ¨ï¼Œç»§ç»­éƒ¨ç½²..."
        }

        # å¯åŠ¨æœåŠ¡
        start_services() {
          log "ğŸš€ å¯åŠ¨åº”ç”¨æœåŠ¡..."
          
          # ç¡®ä¿PM2å·²å®‰è£…
          if ! command -v pm2 &> /dev/null; then
            sudo npm install -g pm2 serve
          fi
          
          # å¯åŠ¨åç«¯æœåŠ¡ï¼ˆä½¿ç”¨éš”ç¦»å‘½åï¼‰
          pm2 start "$APP_DIR/backend/server.js" \
            --name "${PROJECT_PREFIX}-backend" \
            --cwd "$APP_DIR/backend" \
            --env production \
            --output "/var/log/${PROJECT_PREFIX}-backend.log" \
            --error "/var/log/${PROJECT_PREFIX}-backend-error.log" \
            --max-memory-restart 1G
          
          # å¯åŠ¨å‰ç«¯æœåŠ¡ï¼ˆä½¿ç”¨éš”ç¦»å‘½åï¼‰
          pm2 start serve \
            --name "${PROJECT_PREFIX}-frontend" \
            -- -s "$APP_DIR/frontend" -l "$FRONTEND_PORT" \
            --output "/var/log/${PROJECT_PREFIX}-frontend.log" \
            --error "/var/log/${PROJECT_PREFIX}-frontend-error.log" \
            --max-memory-restart 512M
          
          # ä¿å­˜PM2é…ç½®
          pm2 save
        }

        # é…ç½®Nginxåå‘ä»£ç†
        setup_nginx() {
          log "ğŸŒ é…ç½®Nginxåå‘ä»£ç†..."
          
          # å®‰è£…Nginxï¼ˆå¦‚æœæœªå®‰è£…ï¼‰
          if ! command -v nginx &> /dev/null; then
            log "ğŸ“¦ å®‰è£…Nginx..."
            sudo apt update
            sudo apt install -y nginx
          fi
          
          # åˆ›å»ºéš”ç¦»çš„Nginxé…ç½®
          local nginx_conf="/etc/nginx/sites-available/${PROJECT_PREFIX}-resume.conf"
          sudo tee "$nginx_conf" > /dev/null << NGINX_EOF
        # AIä¿Šæ‰ç¤¾ç®€å†ç³»ç»Ÿ - éš”ç¦»é…ç½®
        # é¡¹ç›®å‰ç¼€: ${PROJECT_PREFIX}
        # éƒ¨ç½²ID: ${DEPLOY_ID}

        # å…¨å±€å®‰å…¨è®¾ç½®
        client_max_body_size 10M;
        server_tokens off;

        # é™åˆ¶è¯·æ±‚é¢‘ç‡
        limit_req_zone \$binary_remote_addr zone=${PROJECT_PREFIX}_api:10m rate=10r/s;
        limit_req_zone \$binary_remote_addr zone=${PROJECT_PREFIX}_web:10m rate=30r/s;

        server {
            listen 80;
            server_name _;
            
            # æ·»åŠ å®‰å…¨å¤´
            add_header X-Frame-Options DENY;
            add_header X-Content-Type-Options nosniff;
            add_header X-XSS-Protection "1; mode=block";
            add_header Referrer-Policy "strict-origin-when-cross-origin";
            
            # åº”ç”¨è¯·æ±‚é¢‘ç‡é™åˆ¶
            limit_req zone=${PROJECT_PREFIX}_web burst=20 nodelay;
            
            # å‰ç«¯é™æ€æ–‡ä»¶ - è½¬å‘åˆ°ç«¯å£${FRONTEND_PORT}
            location / {
                proxy_pass http://127.0.0.1:${FRONTEND_PORT};
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_connect_timeout 30s;
                proxy_send_timeout 30s;
                proxy_read_timeout 30s;
                
                # ç¼“å­˜é™æ€èµ„æº
                location ~* \\.(js|css|png|jpg|jpeg|gif|ico|svg)\$ {
                    expires 1y;
                    add_header Cache-Control "public, immutable";
                }
            }
            
            # åç«¯API - è½¬å‘åˆ°ç«¯å£${BACKEND_PORT}
            location /api {
                limit_req zone=${PROJECT_PREFIX}_api burst=10 nodelay;
                
                proxy_pass http://127.0.0.1:${BACKEND_PORT};
                proxy_set_header Host \$host;
                proxy_set_header X-Real-IP \$remote_addr;
                proxy_set_header X-Forwarded-For \$proxy_add_x_forwarded_for;
                proxy_set_header X-Forwarded-Proto \$scheme;
                proxy_connect_timeout 30s;
                proxy_send_timeout 30s;
                proxy_read_timeout 30s;
            }
            
            # å¥åº·æ£€æŸ¥
            location /health {
                access_log off;
                return 200 "OK - Project: ${PROJECT_PREFIX}";
                add_header Content-Type text/plain;
            }
            
            # ç¦æ­¢è®¿é—®æ•æ„Ÿæ–‡ä»¶
            location ~ /\\. {
                deny all;
            }
            
            location ~ \\.(yml|yaml|json|env)\$ {
                deny all;
            }
        }
        NGINX_EOF
          
          # å¯ç”¨é…ç½®
          sudo ln -sf "$nginx_conf" "/etc/nginx/sites-enabled/${PROJECT_PREFIX}-resume.conf"
          
          # ç§»é™¤é»˜è®¤é…ç½®ï¼ˆå¦‚æœå­˜åœ¨ä¸”æ²¡æœ‰å…¶ä»–é…ç½®ï¼‰
          if [ $(ls /etc/nginx/sites-enabled/ | grep -v "${PROJECT_PREFIX}-resume.conf" | wc -l) -eq 0 ]; then
            sudo rm -f /etc/nginx/sites-enabled/default
          fi
          
          # æµ‹è¯•å¹¶é‡è½½Nginx
          if sudo nginx -t; then
            sudo systemctl enable nginx
            sudo systemctl reload nginx
            log "âœ… Nginxé…ç½®æ›´æ–°æˆåŠŸ"
          else
            log "âŒ Nginxé…ç½®æµ‹è¯•å¤±è´¥"
            exit 1
          fi
        }

        # å¥åº·æ£€æŸ¥
        health_check() {
          log "ğŸ¥ æ‰§è¡Œå¥åº·æ£€æŸ¥..."
          
          sleep 15  # ç­‰å¾…æœåŠ¡å¯åŠ¨
          
          local health_ok=true
          
          # æ£€æŸ¥åç«¯API
          if curl -f -m 10 "http://127.0.0.1:$BACKEND_PORT/api/health" 2>/dev/null; then
            log "âœ… åç«¯APIå¥åº· (ç«¯å£: $BACKEND_PORT)"
          else
            log "âŒ åç«¯APIå¥åº·æ£€æŸ¥å¤±è´¥"
            health_ok=false
          fi
          
          # æ£€æŸ¥å‰ç«¯
          if curl -f -m 10 "http://127.0.0.1:$FRONTEND_PORT" 2>/dev/null; then
            log "âœ… å‰ç«¯æœåŠ¡å¥åº· (ç«¯å£: $FRONTEND_PORT)"
          else
            log "âŒ å‰ç«¯æœåŠ¡å¥åº·æ£€æŸ¥å¤±è´¥"
            health_ok=false
          fi
          
          # æ£€æŸ¥Nginxä»£ç†
          if curl -f -m 10 "http://127.0.0.1/health" 2>/dev/null; then
            log "âœ… Nginxä»£ç†å¥åº·"
          else
            log "âŒ Nginxä»£ç†å¥åº·æ£€æŸ¥å¤±è´¥"
            health_ok=false
          fi
          
          # æ£€æŸ¥æ•°æ®åº“è¿æ¥
          local db_container="${PROJECT_PREFIX}-postgres"
          if docker exec "$db_container" pg_isready -U "${PROJECT_PREFIX}_resume_user" 2>/dev/null; then
            log "âœ… æ•°æ®åº“è¿æ¥æ­£å¸¸"
          else
            log "âŒ æ•°æ®åº“è¿æ¥å¤±è´¥"
            health_ok=false
          fi
          
          if [ "$health_ok" = false ]; then
            log "âŒ å¥åº·æ£€æŸ¥å‘ç°é—®é¢˜"
            return 1
          fi
          
          return 0
        }

        # æ˜¾ç¤ºéƒ¨ç½²ç»“æœ
        show_result() {
          log "ğŸ‰ éƒ¨ç½²å®Œæˆï¼"
          echo ""
          echo "ğŸ“Š æœåŠ¡çŠ¶æ€ï¼š"
          pm2 list | grep "$PROJECT_PREFIX"
          echo ""
          echo "ğŸŒ è®¿é—®åœ°å€ï¼š"
          echo "   - ç½‘ç«™: http://$(curl -s ifconfig.me)/"
          echo "   - å‰ç«¯ç›´æ¥è®¿é—®: http://$(curl -s ifconfig.me):$FRONTEND_PORT"
          echo "   - åç«¯API: http://$(curl -s ifconfig.me):$BACKEND_PORT"
          echo ""
          echo "ğŸ”§ ç®¡ç†å‘½ä»¤ï¼š"
          echo "   - æŸ¥çœ‹åç«¯æ—¥å¿—: pm2 logs ${PROJECT_PREFIX}-backend"
          echo "   - æŸ¥çœ‹å‰ç«¯æ—¥å¿—: pm2 logs ${PROJECT_PREFIX}-frontend"
          echo "   - é‡å¯åç«¯: pm2 restart ${PROJECT_PREFIX}-backend"
          echo "   - é‡å¯å‰ç«¯: pm2 restart ${PROJECT_PREFIX}-frontend"
          echo "   - æŸ¥çœ‹éƒ¨ç½²æ—¥å¿—: tail -f $LOG_FILE"
          echo ""
          echo "ğŸ”’ éš”ç¦»ä¿¡æ¯ï¼š"
          echo "   - é¡¹ç›®å‰ç¼€: $PROJECT_PREFIX"
          echo "   - éƒ¨ç½²ID: $DEPLOY_ID"
          echo "   - å‰ç«¯ç«¯å£: $FRONTEND_PORT"
          echo "   - åç«¯ç«¯å£: $BACKEND_PORT"
          echo "   - æ•°æ®åº“å®¹å™¨: ${PROJECT_PREFIX}-postgres"
        }

        # ä¸»éƒ¨ç½²æµç¨‹
        main() {
          log "ğŸš€ å¼€å§‹å®‰å…¨éš”ç¦»éƒ¨ç½²æµç¨‹"
          log "é¡¹ç›®å‰ç¼€: $PROJECT_PREFIX | éƒ¨ç½²ID: $DEPLOY_ID"
          log "å‰ç«¯ç«¯å£: $FRONTEND_PORT | åç«¯ç«¯å£: $BACKEND_PORT"
          
          safe_precheck
          backup_existing
          setup_database
          deploy_application
          start_services
          setup_nginx
          
          if health_check; then
            show_result
            log "âœ… éƒ¨ç½²æˆåŠŸå®Œæˆ"
            
            # åˆ›å»ºç¬¦å·é“¾æ¥åˆ°æ ‡å‡†è·¯å¾„ï¼ˆæ–¹ä¾¿ç®¡ç†ï¼‰
            ln -sfn "$APP_DIR" "/home/$DEPLOY_USER/$PROJECT_NAME"
          else
            log "âŒ å¥åº·æ£€æŸ¥å¤±è´¥ï¼Œå¼€å§‹å›æ»š"
            cleanup_on_error
          fi
        }

        # æ‰§è¡Œä¸»å‡½æ•°
        main
        DEPLOY_EOF

        chmod +x deploy/scripts/*.sh
        echo "âœ… å®‰å…¨éš”ç¦»éƒ¨ç½²åŒ…åˆ›å»ºå®Œæˆ"

    - name: ä¸Šä¼ éƒ¨ç½²åŒ…åˆ°æœåŠ¡å™¨
      uses: appleboy/scp-action@v0.1.7
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        source: "deploy/*"
        target: "/tmp/${{ env.DEPLOY_ID }}"
        strip_components: 1

    - name: æ‰§è¡Œå®‰å…¨éš”ç¦»éƒ¨ç½²
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.HOST }}
        username: ${{ secrets.USERNAME }}
        key: ${{ secrets.PRIVATE_KEY }}
        port: ${{ secrets.SSH_PORT || 22 }}
        command_timeout: 30m
        script: |
          # è®¾ç½®ç¯å¢ƒå˜é‡ï¼ˆä»GitHub Secretsä¼ é€’ï¼‰
          export DB_PASSWORD="${{ secrets.DB_PASSWORD }}"
          export JWT_SECRET="${{ secrets.JWT_SECRET }}"
          export AGICTO_API_KEY="${{ secrets.AGICTO_API_KEY }}"
          export TENCENT_SECRET_ID="${{ secrets.TENCENT_SECRET_ID }}"
          export TENCENT_SECRET_KEY="${{ secrets.TENCENT_SECRET_KEY }}"
          
          # æ‰§è¡Œéš”ç¦»éƒ¨ç½²è„šæœ¬ï¼ˆä¼ é€’æ‰€æœ‰å¿…è¦å‚æ•°ï¼‰
          cd "/tmp/${{ env.DEPLOY_ID }}/scripts"
          chmod +x deploy.sh
          ./deploy.sh "${{ env.DEPLOY_ID }}" "${{ env.PROJECT_PREFIX }}" "${{ env.FRONTEND_PORT }}" "${{ env.BACKEND_PORT }}"
          
          # æ¸…ç†ä¸´æ—¶éƒ¨ç½²æ–‡ä»¶
          rm -rf "/tmp/${{ env.DEPLOY_ID }}"
          
          echo "ğŸ‰ å®‰å…¨éš”ç¦»éƒ¨ç½²å®Œæˆï¼"
          echo "å‰ç«¯ç«¯å£: ${{ env.FRONTEND_PORT }}"
          echo "åç«¯ç«¯å£: ${{ env.BACKEND_PORT }}" 