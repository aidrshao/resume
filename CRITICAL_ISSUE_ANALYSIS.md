# ğŸš¨ å…³é”®é—®é¢˜åˆ†æä¸è§£å†³æ–¹æ¡ˆ

## ğŸ“‹ é—®é¢˜æ€»ç»“

æ ¹æ®æ‚¨æä¾›çš„æ—¥å¿—å’Œé”™è¯¯ä¿¡æ¯ï¼Œæˆ‘å·²ç»å®Œå…¨åˆ†æå‡ºäº†é—®é¢˜çš„æ ¹æœ¬åŸå› ï¼š

### ğŸ” æ ¸å¿ƒé—®é¢˜

1. **SPAè·¯ç”±404é”™è¯¯**: Nginxæ²¡æœ‰æ­£ç¡®é…ç½® `try_files` æŒ‡ä»¤
2. **å‰ç«¯è¿›ç¨‹å†²çª**: éƒ¨ç½²è„šæœ¬é‡æ–°å¯åŠ¨äº† `resume-frontend` è¿›ç¨‹
3. **401è®¤è¯é”™è¯¯**: JWTå¯†é’¥å¯èƒ½åœ¨éƒ¨ç½²è¿‡ç¨‹ä¸­å‘ç”Ÿå˜åŒ–

### ğŸ“Š é”™è¯¯æ—¥å¿—åˆ†æ

```
[2025-07-11T01:25:26.097Z]  "GET /login" Error (404): "Not found"
```
- **é—®é¢˜**: å‰ç«¯PM2è¿›ç¨‹ `resume-frontend` åœ¨å¤„ç†SPAè·¯ç”±
- **åŸå› **: http-serverä¸ç†è§£Reactè·¯ç”±ï¼Œåªèƒ½æœåŠ¡é™æ€æ–‡ä»¶

```
"message": "Request failed with status code 401"
```
- **é—®é¢˜**: åç«¯è®¤è¯å¤±è´¥
- **åŸå› **: JWT_SECRETå¯èƒ½åœ¨éƒ¨ç½²æ—¶æ”¹å˜ï¼Œå¯¼è‡´ç°æœ‰tokenæ— æ•ˆ

## ğŸ¯ è§£å†³æ–¹æ¡ˆ

### æ–¹æ¡ˆä¸€: ä½¿ç”¨ç´§æ€¥ä¿®å¤è„šæœ¬ï¼ˆæ¨èï¼‰

æˆ‘å·²ç»åˆ›å»ºäº†ä¸“é—¨çš„ç´§æ€¥ä¿®å¤è„šæœ¬ï¼š

```bash
sudo bash emergency_spa_fix.sh
```

### æ–¹æ¡ˆäºŒ: ä½¿ç”¨ä¼˜åŒ–çš„éƒ¨ç½²è„šæœ¬

```bash
sudo bash deploy_1.sh --fix-all
```

## ğŸ”§ æŠ€æœ¯ç»†èŠ‚

### 1. SPAè·¯ç”±é…ç½®é—®é¢˜

**é”™è¯¯çš„æ¶æ„**:
```
ç”¨æˆ·è®¿é—® /login â†’ Nginx â†’ PM2(http-server) â†’ 404é”™è¯¯
```

**æ­£ç¡®çš„æ¶æ„**:
```
ç”¨æˆ·è®¿é—® /login â†’ Nginx â†’ try_files â†’ index.html â†’ React Routerå¤„ç†
```

**å…³é”®Nginxé…ç½®**:
```nginx
location / {
    root /home/ubuntu/resume/frontend/build;
    index index.html;
    
    # ğŸ”¥ å…³é”®: SPAè·¯ç”±é…ç½®
    try_files $uri $uri/ /index.html;
}
```

### 2. å‰ç«¯è¿›ç¨‹å†²çªé—®é¢˜

**é—®é¢˜**: éƒ¨ç½²è„šæœ¬ä¸­çš„å‰ç«¯æœåŠ¡é…ç½®éƒ¨åˆ†ä¼šé‡æ–°å¯åŠ¨PM2å‰ç«¯è¿›ç¨‹

**è§£å†³**: 
- åœæ­¢å¹¶åˆ é™¤ `resume-frontend` è¿›ç¨‹
- è®©Nginxç›´æ¥æœåŠ¡é™æ€æ–‡ä»¶
- æ¸…ç†ç«¯å£3016å ç”¨

### 3. JWTè®¤è¯é—®é¢˜

**é—®é¢˜**: éƒ¨ç½²æ—¶JWT_SECRETå¯èƒ½å‘ç”Ÿå˜åŒ–ï¼Œå¯¼è‡´ç°æœ‰tokenå¤±æ•ˆ

**è§£å†³**:
- æ£€æŸ¥JWT_SECRETé…ç½®
- é‡æ–°ç”Ÿæˆå®‰å…¨çš„JWTå¯†é’¥
- é‡å¯åç«¯æœåŠ¡åº”ç”¨æ–°é…ç½®

## ğŸ“ æ–‡ä»¶ä¿®æ”¹æ€»ç»“

### 1. deploy_1.sh ä¼˜åŒ–

- âœ… ä¿®å¤äº†Nginxé…ç½®ä¸­çš„ `ssl_certificate_key` æŒ‡ä»¤
- âœ… æ·»åŠ äº† `fix_spa_routing_issue()` å‡½æ•°
- âœ… æ·»åŠ äº† `fix_auth_token_issue()` å‡½æ•°
- âœ… æ·»åŠ äº† `force_cleanup_frontend_processes()` å‡½æ•°
- âœ… æ–°å¢äº† `--fix-spa`, `--fix-auth`, `--fix-all` é€‰é¡¹

### 2. emergency_spa_fix.sh åˆ›å»º

- âœ… ä¸“é—¨çš„ç´§æ€¥ä¿®å¤è„šæœ¬
- âœ… 7ä¸ªæ­¥éª¤çš„å®Œæ•´ä¿®å¤æµç¨‹
- âœ… è¯¦ç»†çš„éªŒè¯å’Œæµ‹è¯•

## ğŸš€ ç«‹å³æ‰§è¡Œ

è¯·åœ¨æœåŠ¡å™¨ä¸Šç«‹å³æ‰§è¡Œä»¥ä¸‹å‘½ä»¤ï¼š

```bash
# ä¸‹è½½æœ€æ–°çš„ä¿®å¤è„šæœ¬
cd /tmp

# æ‰§è¡Œç´§æ€¥ä¿®å¤
sudo bash /home/ubuntu/resume/emergency_spa_fix.sh
```

## ğŸ§ª éªŒè¯æ­¥éª¤

ä¿®å¤å®Œæˆåï¼Œè¯·æµ‹è¯•ä»¥ä¸‹URLï¼š

1. **ä¸»é¡µ**: https://resume.juncaishe.com
2. **ç™»å½•é¡µ**: https://resume.juncaishe.com/login
3. **ç®€å†é¡µ**: https://resume.juncaishe.com/resumes
4. **å·¥ä½œé¡µ**: https://resume.juncaishe.com/jobs

### é¢„æœŸç»“æœ

- âœ… æ‰€æœ‰é¡µé¢éƒ½åº”è¯¥è¿”å›200çŠ¶æ€ç 
- âœ… ç™»å½•åä¸å†å‡ºç°404é”™è¯¯
- âœ… APIè°ƒç”¨ä¸å†å‡ºç°401é”™è¯¯
- âœ… PM2ä¸­åªæœ‰ `resume-backend` è¿›ç¨‹è¿è¡Œ

## ğŸ“Š æ¶æ„å¯¹æ¯”

### ä¿®å¤å‰ï¼ˆé”™è¯¯æ¶æ„ï¼‰
```
ç”¨æˆ·è¯·æ±‚ â†’ Nginx â†’ PM2(resume-frontend) â†’ http-server â†’ 404
                â†˜ PM2(resume-backend) â†’ APIæ­£å¸¸
```

### ä¿®å¤åï¼ˆæ­£ç¡®æ¶æ„ï¼‰
```
ç”¨æˆ·è¯·æ±‚ â†’ Nginx â†’ é™æ€æ–‡ä»¶(try_files) â†’ React SPA
                â†˜ APIä»£ç† â†’ PM2(resume-backend) â†’ APIæ­£å¸¸
```

## ğŸ” æ—¥å¿—ç›‘æ§

ä¿®å¤åï¼Œè¯·ç›‘æ§ä»¥ä¸‹æ—¥å¿—ï¼š

```bash
# æŸ¥çœ‹PM2çŠ¶æ€
pm2 list

# æŸ¥çœ‹åç«¯æ—¥å¿—
pm2 logs resume-backend --lines 20

# æŸ¥çœ‹Nginxé”™è¯¯æ—¥å¿—
tail -f /var/log/nginx/error.log

# æŸ¥çœ‹Nginxè®¿é—®æ—¥å¿—
tail -f /var/log/nginx/access.log
```

## ğŸ¯ å…³é”®è¦ç‚¹

1. **ä¸è¦è¿è¡Œå‰ç«¯PM2è¿›ç¨‹**: é™æ€æ–‡ä»¶åº”è¯¥ç”±Nginxç›´æ¥æœåŠ¡
2. **æ­£ç¡®é…ç½®SPAè·¯ç”±**: ä½¿ç”¨ `try_files $uri $uri/ /index.html`
3. **ä¿æŒJWTå¯†é’¥ç¨³å®š**: é¿å…åœ¨ç”Ÿäº§ç¯å¢ƒé¢‘ç¹æ›´æ”¹
4. **ç›‘æ§è¿›ç¨‹çŠ¶æ€**: ç¡®ä¿åªæœ‰å¿…è¦çš„æœåŠ¡åœ¨è¿è¡Œ

## ğŸ“ åç»­æ”¯æŒ

å¦‚æœä¿®å¤åä»æœ‰é—®é¢˜ï¼Œè¯·æä¾›ï¼š

1. `pm2 list` çš„è¾“å‡º
2. `nginx -t` çš„ç»“æœ
3. `curl -I https://resume.juncaishe.com/login` çš„å“åº”
4. æµè§ˆå™¨å¼€å‘è€…å·¥å…·çš„Networké¢æ¿æˆªå›¾

---

**æœ€åæ›´æ–°**: 2025-01-11  
**çŠ¶æ€**: ğŸ”¥ ç´§æ€¥ä¿®å¤å°±ç»ªï¼Œè¯·ç«‹å³æ‰§è¡Œ 