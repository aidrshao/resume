# 🛡️ AI俊才社简历系统 - 部署数据保护优化

## 📋 问题概述

在之前的部署脚本中，存在以下会导致数据丢失的问题：

1. **端口变化时删除数据卷**：当数据库端口发生变化时，脚本会自动删除 `postgres_data` 数据卷
2. **连接失败重试时删除数据卷**：数据库连接失败重试时，会删除数据卷重新创建
3. **缺乏数据备份机制**：部署前没有自动备份现有数据

这些问题会导致：
- ✅ **岗位数据丢失**：用户创建的岗位信息被删除
- ✅ **用户数据丢失**：注册用户、简历等数据被清空
- ✅ **无法恢复**：没有备份机制，数据丢失后无法找回

## 🔧 优化方案

### 1. 自动数据备份机制

#### 🔄 部署前自动备份
- **触发时机**：每次运行 `deploy.sh` 时自动执行
- **备份内容**：
  - 数据库完整备份 (`full_backup.sql`)
  - 关键表单独备份：
    - `job_positions`（岗位数据）
    - `users`（用户数据）
    - `resumes`（简历数据）
    - `user_memberships`（会员数据）
- **备份位置**：`/root/backups/pre_deploy_backup_YYYYMMDD_HHMMSS/`

#### 📁 备份目录结构
```
/root/backups/pre_deploy_backup_20250101_120000/
├── full_backup.sql              # 完整数据库备份
├── job_positions_data.sql       # 岗位数据
├── users_data.sql              # 用户数据
├── resumes_data.sql            # 简历数据
├── user_memberships_data.sql   # 会员数据
└── backup_info.txt             # 备份信息
```

### 2. 智能数据卷管理

#### 🧠 智能判断机制
- **全新安装**：直接创建新数据卷，不删除不存在的数据
- **端口变化**：标记需要重置，但会在迁移后自动恢复用户数据
- **连接失败**：减少重试次数，避免过度删除数据卷

#### 🔄 数据恢复流程
1. 检测到数据卷重置需求
2. 在数据库迁移完成后
3. 自动恢复关键用户数据
4. 显示恢复结果

### 3. 智能种子数据处理

#### 📊 数据检查机制
- **检查现有数据**：查询用户表中的数据量
- **智能决策**：
  - 有用户数据 → 跳过种子数据插入
  - 无用户数据 → 插入种子数据
  - 需要恢复 → 先恢复用户数据再处理种子数据

## 🚀 使用方法

### 正常部署（推荐）
```bash
sudo bash deploy.sh
```
- ✅ 自动备份现有数据
- ✅ 智能保护用户数据
- ✅ 显示备份和恢复信息

### 手动恢复备份
```bash
# 查看可用备份
sudo ./restore_backup.sh --list

# 恢复指定备份
sudo ./restore_backup.sh /root/backups/pre_deploy_backup_20250101_120000
```

## 📊 部署信息显示优化

部署完成后会显示：

```
=== 📁 数据备份信息 ===
✅ 部署前已自动备份数据
备份位置: /root/backups/pre_deploy_backup_20250101_120000
备份时间: 2025-01-01 12:00:00
✅ 已自动恢复用户数据到新数据库
恢复内容: 岗位数据、用户信息、简历数据等
```

## 🛠️ 脚本文件说明

### 主要修改的文件
- **`deploy.sh`**：主部署脚本，增加数据保护机制
- **`restore_backup.sh`**：手动备份恢复脚本（新增）

### 新增功能函数
- `backup_database_before_deploy()`：部署前自动备份
- `restore_database_if_needed()`：智能数据恢复
- `setup_database()`：改进的数据库设置（数据保护版）
- `run_database_migration()`：智能迁移处理

## 🔒 安全特性

### 1. 备份安全
- **自动备份**：每次部署前自动创建备份
- **多重备份**：完整备份 + 表级备份
- **备份验证**：检查备份文件完整性

### 2. 恢复安全
- **手动确认**：恢复前需要用户确认
- **智能检测**：自动检测需要恢复的情况
- **完整性检查**：验证数据库连接和文件完整性

### 3. 操作安全
- **权限检查**：需要 root 权限运行
- **状态检查**：检查数据库容器状态
- **错误处理**：详细的错误信息和处理建议

## 📈 性能优化

### 1. 备份优化
- **并行备份**：同时备份多个表
- **增量策略**：只备份用户数据相关表
- **压缩存储**：备份文件自动整理

### 2. 恢复优化
- **智能恢复**：只在需要时恢复数据
- **批量操作**：减少数据库操作次数
- **状态跟踪**：显示详细的恢复进度

## 🎯 测试建议

### 1. 数据保护测试
```bash
# 1. 创建测试数据
# 2. 运行部署脚本
sudo bash deploy.sh
# 3. 验证数据是否保留
```

### 2. 备份恢复测试
```bash
# 1. 查看备份列表
sudo ./restore_backup.sh --list
# 2. 测试恢复功能
sudo ./restore_backup.sh [备份路径]
```

## ⚠️ 重要提醒

1. **定期清理备份**：备份文件会占用磁盘空间，建议定期清理旧备份
2. **权限要求**：所有脚本都需要 root 权限运行
3. **数据库状态**：确保数据库容器正常运行才能进行备份和恢复
4. **备份位置**：备份文件默认存储在 `/root/backups/`，请确保有足够空间

## 🔍 故障排除

### 备份失败
- 检查数据库容器是否运行：`docker ps | grep resume-postgres`
- 检查磁盘空间：`df -h`
- 检查权限：确保使用 `sudo` 运行

### 恢复失败
- 检查备份文件完整性：`ls -la [备份目录]`
- 检查数据库连接：`docker exec resume-postgres psql -U resume_user -d resume_db -c "SELECT 1;"`
- 查看详细错误：脚本会显示具体的错误信息

---

**🎉 现在您的部署脚本已经具备了完整的数据保护机制，再也不用担心岗位数据丢失问题了！** 