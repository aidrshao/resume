# ç«¯å£é…ç½®ç»Ÿä¸€è§£å†³æ–¹æ¡ˆ

## é—®é¢˜æ€»ç»“

ä»Žä½ çš„éƒ¨ç½²æ—¥å¿—å¯ä»¥çœ‹å‡ºä¸¤ä¸ªä¸»è¦é—®é¢˜ï¼š

### 1. ç«¯å£é…ç½®ä¸ä¸€è‡´
- **åŽç«¯å®žé™…è¿è¡Œç«¯å£**: 8001 (åŠ¨æ€åˆ†é…)
- **å‰ç«¯ä»£ç†é…ç½®ç«¯å£**: 8000 (ç¡¬ç¼–ç )
- **å¯¼è‡´ç»“æžœ**: å‰ç«¯æ— æ³•è¿žæŽ¥åˆ°åŽç«¯ ("ERR_CONNECTION_REFUSED")

### 2. å‰ç«¯æœåŠ¡ESMé”™è¯¯
- **é—®é¢˜**: æ–°ç‰ˆæœ¬çš„ `serve` åŒ…æ˜¯ ESM æ¨¡å—ï¼Œä¸Ž PM2 fork æ¨¡å¼ä¸å…¼å®¹
- **ç—‡çŠ¶**: `ERR_REQUIRE_ESM` é”™è¯¯ï¼ŒæœåŠ¡æ˜¾ç¤º online ä½†å®žé™…æœ‰é—®é¢˜

## è§£å†³æ–¹æ¡ˆ

### ðŸ“‹ ä¿®æ”¹å†…å®¹

æˆ‘å·²ç»å¯¹ `deploy_1.sh` è„šæœ¬è¿›è¡Œäº†ä»¥ä¸‹å…³é”®ä¿®æ”¹ï¼š

#### 1. **æ–°å¢žåŠ¨æ€å‰ç«¯ä»£ç†é…ç½®æ›´æ–°**

```bash
# åœ¨ configure_environment() å‡½æ•°ä¸­æ–°å¢ž:
update_frontend_proxy()  # åŠ¨æ€æ›´æ–° setupProxy.js æ–‡ä»¶
```

**åŠŸèƒ½**:
- è‡ªåŠ¨å¤‡ä»½åŽŸä»£ç†é…ç½®
- æ ¹æ® `$FINAL_BACKEND_PORT` åŠ¨æ€ç”Ÿæˆæ–°çš„ä»£ç†é…ç½®
- æ›´æ–°æ‰€æœ‰æµ‹è¯•æ–‡ä»¶ä¸­çš„ç¡¬ç¼–ç ç«¯å£
- ç¡®ä¿å‰ç«¯ä»£ç†æŒ‡å‘æ­£ç¡®çš„åŽç«¯ç«¯å£

#### 2. **å¢žå¼ºå‰ç«¯çŽ¯å¢ƒé…ç½®**

```bash
# åœ¨å‰ç«¯ .env æ–‡ä»¶ä¸­å¢žåŠ :
PORT=$FINAL_FRONTEND_PORT
GENERATE_SOURCEMAP=false
DISABLE_ESLINT_PLUGIN=true
```

#### 3. **ä¿®å¤å‰ç«¯æœåŠ¡å¯åŠ¨çš„ESMé—®é¢˜**

```bash
# ä¼˜å…ˆä½¿ç”¨ http-server (æ›´ç¨³å®š)
npm install -g http-server
pm2 start http-server --name "resume-frontend" -- build -p $FINAL_FRONTEND_PORT

# å¤‡ç”¨æ–¹æ¡ˆä½¿ç”¨å›ºå®šç‰ˆæœ¬çš„ serve
npm install -g serve@13.0.4
```

#### 4. **å¢žå¼ºç«¯å£ä¸€è‡´æ€§æ£€æŸ¥**

æ·»åŠ äº†å¯¹å‰ç«¯ä»£ç†é…ç½®çš„æ£€æŸ¥ï¼š

```bash
# æ£€æŸ¥ setupProxy.js ä¸­çš„ç«¯å£é…ç½®
PROXY_TARGET_PORT=$(grep -o "localhost:[0-9]*" setupProxy.js)
```

### ðŸ”§ æ¶‰åŠçš„æ–‡ä»¶å’Œé…ç½®

#### åŠ¨æ€æ›´æ–°çš„æ–‡ä»¶ï¼š
1. **`frontend/src/setupProxy.js`** - å‰ç«¯ä»£ç†é…ç½®
2. **`frontend/.env`** - å‰ç«¯çŽ¯å¢ƒå˜é‡
3. **`backend/.env`** - åŽç«¯çŽ¯å¢ƒå˜é‡  
4. **`frontend/test-*.html`** - æµ‹è¯•æ–‡ä»¶
5. **`/etc/nginx/sites-available/resume`** - Nginxé…ç½®

#### ç«¯å£å˜é‡æ˜ å°„ï¼š
- `DEFAULT_BACKEND_PORT=8000` â†’ `DETECTED_BACKEND_PORT` â†’ `FINAL_BACKEND_PORT`
- `DEFAULT_FRONTEND_PORT=3016` â†’ `DETECTED_FRONTEND_PORT` â†’ `FINAL_FRONTEND_PORT`
- `DEFAULT_DB_PORT=5434` â†’ `DETECTED_DB_PORT` â†’ `FINAL_DB_PORT`
- `DEFAULT_REDIS_PORT=6379` â†’ `DETECTED_REDIS_PORT` â†’ `FINAL_REDIS_PORT`

### ðŸ“Š ç«¯å£é…ç½®æµç¨‹

```mermaid
graph TD
    A[é»˜è®¤ç«¯å£é…ç½®] --> B[ç«¯å£å ç”¨æ£€æµ‹]
    B --> C{ç«¯å£è¢«å ç”¨?}
    C -->|å¦| D[ä½¿ç”¨é»˜è®¤ç«¯å£]
    C -->|æ˜¯| E[æŸ¥æ‰¾å¯ç”¨ç«¯å£]
    E --> F[åŠ¨æ€åˆ†é…æ–°ç«¯å£]
    D --> G[è®¾ç½®FINAL_*_PORTå˜é‡]
    F --> G
    G --> H[æ›´æ–°æ‰€æœ‰é…ç½®æ–‡ä»¶]
    H --> I[å¯åŠ¨æœåŠ¡]
    I --> J[éªŒè¯ç«¯å£ä¸€è‡´æ€§]
```

## ä½¿ç”¨æ–¹æ³•

### æ–¹æ¡ˆ1: é‡æ–°è¿è¡Œæ›´æ–°åŽçš„éƒ¨ç½²è„šæœ¬ï¼ˆæŽ¨èï¼‰

```bash
# 1. åœæ­¢çŽ°æœ‰æœåŠ¡
pm2 stop all

# 2. è¿è¡Œæ›´æ–°åŽçš„éƒ¨ç½²è„šæœ¬
sudo ./deploy_1.sh

# è„šæœ¬ä¼šè‡ªåŠ¨ï¼š
# - æ£€æµ‹ç«¯å£å ç”¨æƒ…å†µ
# - åŠ¨æ€åˆ†é…å¯ç”¨ç«¯å£
# - æ›´æ–°æ‰€æœ‰ç›¸å…³é…ç½®æ–‡ä»¶
# - å¯åŠ¨æœåŠ¡å¹¶éªŒè¯
```

### æ–¹æ¡ˆ2: æ‰‹åŠ¨æ‰§è¡Œç«¯å£é…ç½®ä¿®å¤

å¦‚æžœåªæƒ³ä¿®å¤ç«¯å£é—®é¢˜ï¼Œä¸é‡æ–°éƒ¨ç½²ï¼š

```bash
# 1. è®¾ç½®ç«¯å£å˜é‡
FINAL_BACKEND_PORT=8001  # æ ¹æ®å®žé™…æƒ…å†µè®¾ç½®
FINAL_FRONTEND_PORT=3016

# 2. æ›´æ–°å‰ç«¯ä»£ç†é…ç½®
cat > frontend/src/setupProxy.js << EOF
const { createProxyMiddleware } = require('http-proxy-middleware');
module.exports = function(app) {
  app.use('/api', createProxyMiddleware({
    target: 'http://localhost:$FINAL_BACKEND_PORT',
    changeOrigin: true,
  }));
};
EOF

# 3. æ›´æ–°å‰ç«¯çŽ¯å¢ƒå˜é‡
cat > frontend/.env << EOF
REACT_APP_API_URL=http://localhost:$FINAL_BACKEND_PORT/api
PORT=$FINAL_FRONTEND_PORT
GENERATE_SOURCEMAP=false
DISABLE_ESLINT_PLUGIN=true
EOF

# 4. é‡æ–°æž„å»ºå¹¶å¯åŠ¨å‰ç«¯
cd frontend
npm run build
pm2 stop resume-frontend
pm2 delete resume-frontend
pm2 start http-server --name "resume-frontend" -- build -p $FINAL_FRONTEND_PORT
pm2 save
```

## éªŒè¯æ­¥éª¤

### 1. æ£€æŸ¥æœåŠ¡çŠ¶æ€
```bash
pm2 status
# åº”è¯¥çœ‹åˆ° resume-backend å’Œ resume-frontend éƒ½æ˜¯ online çŠ¶æ€
```

### 2. æ£€æŸ¥ç«¯å£ç›‘å¬
```bash
lsof -i :8001  # åŽç«¯ç«¯å£
lsof -i :3016  # å‰ç«¯ç«¯å£
```

### 3. æµ‹è¯•APIè¿žæŽ¥
```bash
curl -s http://localhost:8001/api/health
# åº”è¯¥è¿”å›žå¥åº·æ£€æŸ¥ä¿¡æ¯
```

### 4. æµ‹è¯•å‰ç«¯è®¿é—®
```bash
curl -s http://localhost:3016
# åº”è¯¥è¿”å›žHTMLå†…å®¹
```

### 5. æ£€æŸ¥é…ç½®ä¸€è‡´æ€§
```bash
# æ£€æŸ¥åŽç«¯é…ç½®
grep "^PORT=" backend/.env

# æ£€æŸ¥å‰ç«¯é…ç½®  
grep "^REACT_APP_API_URL=" frontend/.env

# æ£€æŸ¥ä»£ç†é…ç½®
grep -o "localhost:[0-9]*" frontend/src/setupProxy.js
```

## æŠ€æœ¯è¯´æ˜Ž

### ç«¯å£åŠ¨æ€åˆ†é…æœºåˆ¶

`deploy_1.sh` è„šæœ¬ä½¿ç”¨ä»¥ä¸‹ç­–ç•¥è¿›è¡Œç«¯å£ç®¡ç†ï¼š

1. **ç«¯å£æ£€æµ‹**: ä½¿ç”¨ `lsof` æ£€æµ‹ç«¯å£å ç”¨æƒ…å†µ
2. **æ™ºèƒ½å¤ç”¨**: å¦‚æžœæ£€æµ‹åˆ°ç›¸åŒæœåŠ¡å ç”¨ç«¯å£ï¼Œåˆ™å¤ç”¨è¯¥ç«¯å£
3. **åŠ¨æ€åˆ†é…**: å¦‚æžœç«¯å£è¢«å…¶ä»–æœåŠ¡å ç”¨ï¼Œä»Žä¸‹ä¸€ä¸ªç«¯å£å¼€å§‹æŸ¥æ‰¾å¯ç”¨ç«¯å£
4. **å†²çªé¿å…**: ç¡®ä¿æ‰€æœ‰æœåŠ¡ä½¿ç”¨ä¸åŒçš„ç«¯å£
5. **é…ç½®åŒæ­¥**: æ›´æ–°æ‰€æœ‰ç›¸å…³é…ç½®æ–‡ä»¶ä»¥ä½¿ç”¨åˆ†é…çš„ç«¯å£

### ESMå…¼å®¹æ€§è§£å†³æ–¹æ¡ˆ

1. **ä¼˜å…ˆä½¿ç”¨ http-server**: æ›´ç¨³å®šï¼Œä¸ŽPM2å…¼å®¹æ€§æ›´å¥½
2. **å¤‡ç”¨ä½¿ç”¨ serve@13.0.4**: å›ºå®šç‰ˆæœ¬é¿å…ESMé—®é¢˜  
3. **æœ€åŽä½¿ç”¨å¯åŠ¨è„šæœ¬**: é€šè¿‡è„šæœ¬åŒ…è£…è§£å†³å…¼å®¹æ€§é—®é¢˜

### é…ç½®æ–‡ä»¶æ¨¡æ¿åŒ–

æ‰€æœ‰é…ç½®æ–‡ä»¶éƒ½ä½¿ç”¨ `$FINAL_*_PORT` å˜é‡åŠ¨æ€ç”Ÿæˆï¼Œç¡®ä¿ï¼š
- ç«¯å£é…ç½®çš„ä¸€è‡´æ€§
- é…ç½®çš„å¯ç»´æŠ¤æ€§
- éƒ¨ç½²çš„å¯é‡å¤æ€§

## æ•…éšœæŽ’é™¤

### å¦‚æžœå‰ç«¯ä»ç„¶è¿žæŽ¥å¤±è´¥

1. **æ£€æŸ¥ä»£ç†é…ç½®**:
   ```bash
   cat frontend/src/setupProxy.js
   # ç¡®è®¤targetæŒ‡å‘æ­£ç¡®çš„åŽç«¯ç«¯å£
   ```

2. **æ£€æŸ¥æµè§ˆå™¨æŽ§åˆ¶å°**:
   - çœ‹æ˜¯å¦è¿˜æœ‰8000ç«¯å£çš„è¯·æ±‚
   - ç¡®è®¤APIè¯·æ±‚æ˜¯å¦æ­£ç¡®ä»£ç†

3. **æ¸…é™¤æµè§ˆå™¨ç¼“å­˜**:
   - ç¡¬åˆ·æ–°é¡µé¢ (Ctrl+F5)
   - æ¸…é™¤åº”ç”¨ç¼“å­˜

### å¦‚æžœæœåŠ¡å¯åŠ¨å¤±è´¥

1. **æŸ¥çœ‹è¯¦ç»†æ—¥å¿—**:
   ```bash
   pm2 logs resume-frontend --lines 50
   pm2 logs resume-backend --lines 50
   ```

2. **æ£€æŸ¥ç«¯å£å ç”¨**:
   ```bash
   netstat -tlnp | grep -E ":(8001|3016) "
   ```

3. **æ‰‹åŠ¨æµ‹è¯•å¯åŠ¨**:
   ```bash
   cd frontend
   npx http-server build -p 3016
   ```

## é¢„é˜²æŽªæ–½

1. **ç«¯å£é…ç½®é›†ä¸­ç®¡ç†**: æ‰€æœ‰ç«¯å£éƒ½é€šè¿‡è„šæœ¬å˜é‡ç®¡ç†
2. **è‡ªåŠ¨é…ç½®åŒæ­¥**: è„šæœ¬ç¡®ä¿æ‰€æœ‰é…ç½®æ–‡ä»¶åŒæ­¥æ›´æ–°
3. **ä¸€è‡´æ€§éªŒè¯**: éƒ¨ç½²å®ŒæˆåŽè‡ªåŠ¨éªŒè¯æ‰€æœ‰ç«¯å£é…ç½®
4. **å¤‡ä»½æœºåˆ¶**: æ‰€æœ‰é…ç½®æ–‡ä»¶ä¿®æ”¹å‰éƒ½ä¼šè‡ªåŠ¨å¤‡ä»½

---

**ä¿®æ”¹åŽçš„ `deploy_1.sh` è„šæœ¬çŽ°åœ¨å…·æœ‰å®Œæ•´çš„ç«¯å£é…ç½®ç®¡ç†èƒ½åŠ›ï¼Œèƒ½å¤Ÿè‡ªåŠ¨å¤„ç†ç«¯å£å†²çªå¹¶ç¡®ä¿æ‰€æœ‰é…ç½®æ–‡ä»¶çš„ä¸€è‡´æ€§ã€‚** 