<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>前端API调试页面</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
            background-color: #f5f5f5;
        }
        .container {
            background: white;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            margin-bottom: 20px;
        }
        .button {
            background: #007bff;
            color: white;
            border: none;
            padding: 10px 20px;
            border-radius: 4px;
            cursor: pointer;
            margin: 5px;
        }
        .button:hover {
            background: #0056b3;
        }
        .log {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 4px;
            padding: 10px;
            margin: 10px 0;
            white-space: pre-wrap;
            font-family: monospace;
            max-height: 300px;
            overflow-y: auto;
        }
        .success {
            color: #28a745;
        }
        .error {
            color: #dc3545;
        }
        .info {
            color: #17a2b8;
        }
        .token-input {
            width: 100%;
            padding: 8px;
            border: 1px solid #ddd;
            border-radius: 4px;
            margin: 5px 0;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>🔧 前端API调试工具</h1>
        <p>这个页面用于调试前端API调用和token问题</p>
    </div>

    <div class="container">
        <h2>📋 Token管理</h2>
        <div>
            <label>当前Token:</label>
            <input type="text" id="tokenInput" class="token-input" placeholder="输入或查看当前token">
        </div>
        <button class="button" onclick="loadCurrentToken()">📥 读取当前Token</button>
        <button class="button" onclick="setNewToken()">💾 设置新Token</button>
        <button class="button" onclick="clearToken()">🗑️ 清除Token</button>
        <button class="button" onclick="generateNewToken()">🔄 生成新Token</button>
    </div>

    <div class="container">
        <h2>🧪 API测试</h2>
        <button class="button" onclick="testTemplatesAPI()">📄 测试模板API</button>
        <button class="button" onclick="testPreviewAPI()">👁️ 测试预览API</button>
        <button class="button" onclick="testPDFAPI()">📋 测试PDF API</button>
        <button class="button" onclick="testResumesAPI()">📝 测试简历API</button>
        <button class="button" onclick="clearLogs()">🧹 清除日志</button>
    </div>

    <div class="container">
        <h2>📊 调试日志</h2>
        <div id="debugLog" class="log">等待调试信息...</div>
    </div>

    <script>
        const API_BASE_URL = 'http://localhost:8000/api';
        
        // 预设的有效token
        const VALID_TOKEN = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJ1c2VySWQiOjIsImVtYWlsIjoidXNlckBleGFtcGxlLmNvbSIsImlhdCI6MTc1MTQyMjI3MCwiZXhwIjoxNzUyMDI3MDcwfQ.9WZTYZoykIfCURTONykyG--JCGbaU7jvP7agUmMn7wk';

        function log(message, type = 'info') {
            const timestamp = new Date().toLocaleTimeString();
            const logElement = document.getElementById('debugLog');
            const className = type === 'error' ? 'error' : type === 'success' ? 'success' : 'info';
            logElement.innerHTML += `<span class="${className}">[${timestamp}] ${message}</span>\n`;
            logElement.scrollTop = logElement.scrollHeight;
            console.log(`[${timestamp}] ${message}`);
        }

        function clearLogs() {
            document.getElementById('debugLog').innerHTML = '日志已清除\n';
        }

        function loadCurrentToken() {
            const token = localStorage.getItem('token');
            document.getElementById('tokenInput').value = token || '';
            if (token) {
                log(`✅ 当前Token: ${token.substring(0, 50)}...`, 'success');
            } else {
                log('❌ 没有找到Token', 'error');
            }
        }

        function setNewToken() {
            const token = document.getElementById('tokenInput').value.trim();
            if (token) {
                localStorage.setItem('token', token);
                log(`✅ Token已设置: ${token.substring(0, 50)}...`, 'success');
            } else {
                log('❌ Token不能为空', 'error');
            }
        }

        function clearToken() {
            localStorage.removeItem('token');
            document.getElementById('tokenInput').value = '';
            log('🗑️ Token已清除', 'info');
        }

        function generateNewToken() {
            document.getElementById('tokenInput').value = VALID_TOKEN;
            localStorage.setItem('token', VALID_TOKEN);
            log('🔄 已生成并设置新的有效Token', 'success');
        }

        async function makeAPIRequest(url, options = {}) {
            const token = localStorage.getItem('token');
            
            log(`🌐 [API请求] 开始请求: ${url}`, 'info');
            log(`🔐 [API请求] Token: ${token ? token.substring(0, 30) + '...' : '无Token'}`, 'info');
            
            const headers = {
                'Content-Type': 'application/json',
                ...options.headers
            };
            
            if (token) {
                headers['Authorization'] = `Bearer ${token}`;
                log(`✅ [API请求] 已添加Authorization头`, 'success');
            } else {
                log(`❌ [API请求] 没有Token，未添加Authorization头`, 'error');
            }
            
            log(`🔐 [API请求] 请求头: ${JSON.stringify(headers, null, 2)}`, 'info');
            
            try {
                const response = await fetch(url, {
                    ...options,
                    headers
                });
                
                log(`📡 [API响应] 状态码: ${response.status}`, response.ok ? 'success' : 'error');
                
                const data = await response.json();
                log(`📡 [API响应] 响应数据: ${JSON.stringify(data, null, 2)}`, response.ok ? 'success' : 'error');
                
                return { response, data };
            } catch (error) {
                log(`❌ [API错误] ${error.message}`, 'error');
                log(`❌ [API错误] 完整错误: ${JSON.stringify(error, null, 2)}`, 'error');
                throw error;
            }
        }

        async function testTemplatesAPI() {
            log('🧪 开始测试模板API...', 'info');
            try {
                const { data } = await makeAPIRequest(`${API_BASE_URL}/resume-render/templates`);
                if (data.success) {
                    log(`✅ 模板API测试成功，获取到 ${data.data.length} 个模板`, 'success');
                } else {
                    log(`❌ 模板API测试失败: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ 模板API测试异常: ${error.message}`, 'error');
            }
        }

        async function testPreviewAPI() {
            log('🧪 开始测试预览API...', 'info');
            try {
                const { data } = await makeAPIRequest(`${API_BASE_URL}/resume-render/preview`, {
                    method: 'POST',
                    body: JSON.stringify({
                        resumeId: 2,
                        templateId: 1
                    })
                });
                if (data.success) {
                    log(`✅ 预览API测试成功，生成了HTML内容 (${data.data.html.length} 字符)`, 'success');
                } else {
                    log(`❌ 预览API测试失败: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ 预览API测试异常: ${error.message}`, 'error');
            }
        }

        async function testPDFAPI() {
            log('🧪 开始测试PDF API...', 'info');
            try {
                const { data } = await makeAPIRequest(`${API_BASE_URL}/resume-render/pdf`, {
                    method: 'POST',
                    body: JSON.stringify({
                        resumeId: 2,
                        templateId: 1
                    })
                });
                if (data.success) {
                    log(`✅ PDF API测试成功，生成了PDF文件: ${data.data.filename}`, 'success');
                } else {
                    log(`❌ PDF API测试失败: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ PDF API测试异常: ${error.message}`, 'error');
            }
        }

        async function testResumesAPI() {
            log('🧪 开始测试简历API...', 'info');
            try {
                const { data } = await makeAPIRequest(`${API_BASE_URL}/resumes`);
                if (data.success) {
                    log(`✅ 简历API测试成功，获取到 ${data.data.length} 个简历`, 'success');
                } else {
                    log(`❌ 简历API测试失败: ${data.message}`, 'error');
                }
            } catch (error) {
                log(`❌ 简历API测试异常: ${error.message}`, 'error');
            }
        }

        // 页面加载时自动读取当前token
        window.onload = function() {
            loadCurrentToken();
            log('🚀 调试页面已加载，可以开始测试', 'success');
        };
    </script>
</body>
</html> 